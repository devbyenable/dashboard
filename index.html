<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enable Earth – Cluster Dashboard</title>

  <!-- Leaflet & MarkerCluster -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css"/>

  <style>
    :root{--primary:#024a18;--accent:#2f7d32;--muted:#e9f3ea}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;background:#fff;color:#1a1a1a}
    header{background:var(--primary);color:#fff;padding:10px 16px;display:flex;align-items:center;gap:12px}
    header img{height:42px}
    header h1{font-size:20px;margin:0;font-weight:600}
    main{padding:16px;max-width:1280px;margin:0 auto}
    .row{display:grid;gap:14px}
    .row.kpi{grid-template-columns:repeat(5,1fr)}
    .kpi{background:var(--muted);border-radius:16px;padding:14px;text-align:center}
    .kpi h3{font-size:14px;font-weight:500;margin:0 0 6px}
    .kpi .val{font-size:22px;font-weight:700}
    h2.sec{font-size:16px;margin:18px 0 8px;color:#333}
    .grid-2{display:grid;gap:14px;grid-template-columns:1.1fr 1fr}
    .card{border:1px solid #e5e7eb;border-radius:12px;background:#fff}
    .card .head{padding:10px 12px;border-bottom:1px solid #eef2f6;font-weight:600}
    .card .body{padding:10px 12px}
    #map{width:100%;height:380px;border-radius:0 0 12px 12px}
    canvas{width:100%!important;height:360px!important}
    table{width:100%;border-collapse:collapse}
    th,td{border-top:1px solid #e6e6e6;border-right:1px solid #f1f1f1;padding:8px 10px;font-size:13px;text-align:center}
    th:last-child,td:last-child{border-right:none}
    thead th{background:#fafafa;position:sticky;top:0;z-index:1}
    .pill{display:inline-block;background:#e8f5e9;color:#1b5e20;padding:2px 8px;border-radius:999px;font-size:12px;font-weight:600}
    .pill.red{background:#ffebee;color:#c62828}
    .muted{color:#6b7280;font-size:12px}
    footer{padding:12px 0 40px;color:#6b7280;text-align:center}
    .pill.link{cursor:pointer;text-decoration:none}
    .pill.link:hover{filter:brightness(.95)}
    @media(max-width:980px){
      .row.kpi{grid-template-columns:repeat(2,1fr)}
      .grid-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header>
    <img src="https://raw.githubusercontent.com/google/material-design-icons/master/png/social/nature_people/materialicons/48dp/2x/outline_nature_people_white_48dp.png" alt="">
    <h1>Enable Earth – Cluster Dashboard</h1>
  </header>

  <main>
    <!-- KPIs -->
    <h2 class="sec">Last 30 days</h2>
    <div class="row kpi" id="kpiRow">
      <div class="kpi"><h3>Agri‑waste collected (ton)</h3><div class="val" id="kpi_waste">X</div></div>
      <div class="kpi"><h3>Fields (rai)</h3><div class="val" id="kpi_fields">X</div></div>
      <div class="kpi"><h3>Number of farmers</h3><div class="val" id="kpi_farmers">X</div></div>
      <div class="kpi"><h3>CO2e prevented (tons)</h3><div class="val" id="kpi_co2e">X</div></div>
      <div class="kpi"><h3>Time spent (hr/ton)</h3><div class="val" id="kpi_time">X</div><div class="muted">X (Y% increase)</div></div>
    </div>

    <h2 class="sec">Next 30 days</h2>

    <div class="grid-2">
      <!-- Bar chart -->
      <section class="card">
        <div class="head">Agri‑waste available for us to go collect (bar chart below)</div>
        <div class="body">
          <canvas id="barChart"></canvas>
        </div>
      </section>

      <!-- Map -->
      <section class="card">
        <div class="head">Cluster map (click markers for detail)</div>
        <div class="body" style="padding:0">
          <div id="map"></div>
        </div>
      </section>
    </div>

    <!-- Decision table -->
    <section class="card" style="margin-top:16px;">
      <div class="head">Cluster screening table</div>
      <div class="body" style="padding:0">
        <div class="muted" style="padding:8px 12px">
          <!--Rules (ตัวอย่าง): <b>if &lt; 10 rai → no go</b>, <b>if &lt; 5 tons → no go</b>, <b>if &gt; 30 km → no go</b>, <b>if &gt; 500 THB/ton → no go</b>, <b>if emission &gt; Y → no go</b>-->
        </div>
        <table id="tbl">
          <thead>
            <tr>
              <th style="min-width:110px">Cluster</th>
              <th>Total fields (rai)</th>
              <th>Agri‑waste available (ton)</th>
              <th>Distance from our facility (km)</th>
              <th>Time to cluster (hr)</th>
              <th>Time spent (hr)</th>
              <th>Energy used (kWh)</th>
              <th>Cost (THB/ton)</th>
              <th>Emission released (CO2e)</th>
              <th>Decision to go</th>
            </tr>
          </thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- <footer>Built with Leaflet + Chart.js | Data source: Google Sheets (CSV)</footer> -->

  <!-- libs -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>

  <script>
  /*
   * =======================
   *  Google Sheet structure
   * =======================
   * 1) KPIs sheet (1 row)
   *    agri_waste_30d, fields_rai, farmers, co2e_prevented, time_hr_per_ton, time_pct_change
   *
   * 2) BAR sheet (time-series for next 30 days)
   *    date, tons
   *
   * 3) PLOTS sheet (points)
   *    plot_id, lat, lng, carbon, cluster_id, fields_rai, is_biochar  (is_biochar TRUE/FALSE)
   *
   *  step: File → Share → Publish to web → เลือก CSV แล้วเอา URL มาใส่ในตัวแปรด้านล่าง
   */

  // ======= CONFIG: ใส่ URL CSV จาก Google Sheets ที่นี่ =======
  const KPIS_CSV  = ""; // ex. 'https://docs.google.com/spreadsheets/d/e/xxxx/pub?gid=0&single=true&output=csv'
  const BAR_CSV   = "";
  const PLOTS_CSV = ""; // ใส่ลิงก์ CSV จริงเพื่อแทนที่ demo

  // ======= CONSTANT (สามารถปรับได้) =======
  const SPEED_KMH = 40;          // ใช้ประเมินเวลาเดินทาง
  const ENERGY_KWH_PER_KM = 0.8; // ใช้ประเมินพลังงาน
  const COST_THB_PER_KM = 15;    // สำหรับคำนวณ cost/ton
  const EMISSION_KG_PER_KM = 0.25; // ตัวอย่าง factor CO2e/กม.
  const EMISSION_LIMIT = 9999;   // เกณฑ์ Y (ตัวอย่าง ทำผ่านเสมอ)

  // ======= DEMO DATA (ใช้เมื่อไม่ใส่ลิงก์ชีท) =======
  const demoKPIs = { agri_waste_30d: 1420, fields_rai: 315, farmers: 128, co2e_prevented: 260, time_hr_per_ton: 1.8, time_pct_change: 7 };
  const demoBAR = [
    {date:'2025-02-10', tons: 45},{date:'2025-03-10', tons: 55},{date:'2025-04-10', tons: 52},
    {date:'2025-05-10', tons: 58},{date:'2025-06-10', tons: 60},{date:'2025-07-10', tons: 33}
  ];
  const demoPlots = [
    {plot_id:'Biochar Plant', lat:19.22956, lng:99.490782, carbon:0, cluster_id:'A', fields_rai:0,  is_biochar:true},
    {plot_id:'MJD001', lat:19.18492, lng:99.56857,  carbon:4.1, cluster_id:'A', fields_rai:12, is_biochar:false},
    {plot_id:'MJD002', lat:19.18308, lng:99.56974,  carbon:3.9, cluster_id:'A', fields_rai:10, is_biochar:false},
    {plot_id:'MJD003', lat:19.18147, lng:99.56686,  carbon:4.4, cluster_id:'A', fields_rai:9,  is_biochar:false},
    {plot_id:'MJD004', lat:19.18441, lng:99.56497,  carbon:3.6, cluster_id:'A', fields_rai:11, is_biochar:false},
    {plot_id:'MJD005', lat:19.18251, lng:99.56358,  carbon:4.2, cluster_id:'A', fields_rai:8,  is_biochar:false},
    {plot_id:'MJD006', lat:19.18018, lng:99.56442,  carbon:4.0, cluster_id:'A', fields_rai:7,  is_biochar:false},
    {plot_id:'MJD007', lat:19.17893, lng:99.56742,  carbon:3.7, cluster_id:'A', fields_rai:6,  is_biochar:false},
    {plot_id:'MJD008', lat:19.18372, lng:99.56231,  carbon:4.5, cluster_id:'A', fields_rai:13, is_biochar:false},
    {plot_id:'MJD009', lat:19.18067, lng:99.56113,  carbon:3.8, cluster_id:'A', fields_rai:9,  is_biochar:false},
    {plot_id:'MJD010', lat:19.18624, lng:99.56934,  carbon:4.3, cluster_id:'A', fields_rai:10, is_biochar:false},
    {plot_id:'B001',   lat:19.2501,  lng:99.6001, carbon:6.2, cluster_id:'B', fields_rai:12, is_biochar:false},
    {plot_id:'B002',   lat:19.2510,  lng:99.6020, carbon:5.1, cluster_id:'B', fields_rai:9,  is_biochar:false},
    {plot_id:'B003',   lat:19.2490,  lng:99.6030, carbon:4.8, cluster_id:'B', fields_rai:7,  is_biochar:false}
  ];

  // ======= STATE =======
  let map, markerCluster, barChart;
  let ALL_PLOTS = []; // ให้ฟังก์ชันอื่นอ้างได้

  // --------- utils ----------
  function km(a,b){
    return turf.distance(turf.point([a.lng,a.lat]), turf.point([b.lng,b.lat]), {units:'kilometers'});
  }
  function fmt(n,dec=0){
    if(n==null || isNaN(n)) return '–';
    return Number(n).toLocaleString(undefined,{maximumFractionDigits:dec,minimumFractionDigits:dec});
  }

  // --------- load CSV or demo ----------
  async function loadCSV(url){
    if(!url) return null;
    return new Promise((resolve,reject)=>{
      Papa.parse(url,{download:true,header:true,complete:r=>resolve(r.data),error:reject});
    });
  }

  async function bootstrap(){
    // 1) KPIs
    let kpis = demoKPIs;
    if(KPIS_CSV){
      const rows = await loadCSV(KPIS_CSV);
      if(rows && rows.length){
        const r = rows[0];
        kpis = {
          agri_waste_30d:+r.agri_waste_30d,
          fields_rai:+r.fields_rai,
          farmers:+r.farmers,
          co2e_prevented:+r.co2e_prevented,
          time_hr_per_ton:+r.time_hr_per_ton,
          time_pct_change:+r.time_pct_change
        };
      }
    }
    // render KPIs
    document.getElementById('kpi_waste').textContent   = fmt(kpis.agri_waste_30d);
    document.getElementById('kpi_fields').textContent   = fmt(kpis.fields_rai);
    document.getElementById('kpi_farmers').textContent  = fmt(kpis.farmers);
    document.getElementById('kpi_co2e').textContent     = fmt(kpis.co2e_prevented);
    document.getElementById('kpi_time').textContent     = fmt(kpis.time_hr_per_ton,2);

    // 2) Bar series
    let series = demoBAR;
    if(BAR_CSV){
      const rows = await loadCSV(BAR_CSV);
      if(rows && rows.length){
        series = rows.map(r=>({date:r.date, tons:+r.tons})).filter(x=>!isNaN(x.tons));
      }
    }
    drawBar(series);

    // 3) Plots for map + table
    let plots = demoPlots;
    if(PLOTS_CSV){
      const rows = await loadCSV(PLOTS_CSV);
      if(rows && rows.length){
        plots = rows.map(r=>({
          plot_id:r.plot_id,
          lat:+r.lat, lng:+r.lng,
          carbon:+r.carbon,
          cluster_id:r.cluster_id,
          fields_rai:+(r.fields_rai||0),
          is_biochar: String(r.is_biochar).toUpperCase()==='TRUE'
        })).filter(p=>!isNaN(p.lat)&&!isNaN(p.lng));
      }
    }
    ALL_PLOTS = plots; // เก็บไว้ให้เปิดหน้า cluster ได้

    initMap(plots);
    fillDecisionTable(plots);
  }

  // --------- chart ----------
  function drawBar(series){
    const ctx = document.getElementById('barChart');
    if(barChart) barChart.destroy();
    barChart = new Chart(ctx,{
      type:'bar',
      data:{
        labels: series.map(s=>new Date(s.date).toLocaleDateString()),
        datasets:[{ label:'tons', data: series.map(s=>s.tons) }]
      },
      options:{ plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
    });
  }

  // --------- map ----------
  function initMap(plots){
    map = L.map('map').setView([19.2, 99.56], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);
    markerCluster = L.markerClusterGroup();
    // add biochar plant first
    const plant = plots.find(p=>p.is_biochar);
    if(plant){
      L.marker([plant.lat,plant.lng],{
        title:'Biochar Plant',
        icon:L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png',iconSize:[30,30]})
      }).addTo(map).bindPopup('<b>Biochar Plant</b>');
    }
    // normal plots
    plots.filter(p=>!p.is_biochar).forEach(p=>{
      const m = L.marker([p.lat,p.lng]).bindPopup(`<b>${p.plot_id}</b><br/>Cluster: ${p.cluster_id}<br/>Residues: ${fmt(p.carbon,1)} ton`);
      markerCluster.addLayer(m);
    });
    map.addLayer(markerCluster);
    if(markerCluster.getLayers().length){
      map.fitBounds(markerCluster.getBounds(),{padding:[20,20]});
    }
  }

  // --------- decision table ----------
  function groupByCluster(plots){
    const plant = plots.find(p=>p.is_biochar);
    const clusters = {};
    plots.filter(p=>!p.is_biochar).forEach(p=>{
      (clusters[p.cluster_id] ||= []).push(p);
    });
    return {plant, clusters};
  }

  function fillDecisionTable(plots){
    const {plant, clusters} = groupByCluster(plots);
    const tbody = document.getElementById('tblBody');
    tbody.innerHTML = '';

    Object.keys(clusters).sort().forEach(cid=>{
      const pts = clusters[cid];
      const totalFields = pts.reduce((s,p)=>s+(p.fields_rai||0),0);
      const totalTons   = pts.reduce((s,p)=>s+(p.carbon||0),0);

      // centroid for cluster
      const fc = turf.featureCollection(pts.map(p=>turf.point([p.lng,p.lat])));
      const cen = turf.centroid(fc);
      const hub = {lat:cen.geometry.coordinates[1], lng:cen.geometry.coordinates[0]};

      // distance from facility (plant) → hub
      const distKm = plant ? km(plant, hub) : 0;
      const timeToClusterHr = distKm / SPEED_KMH;

      // rough time spent collecting (สมมติ 0.25 hr / ton)
      const timeSpentHr = totalTons * 0.25;

      const energyKWh = distKm * ENERGY_KWH_PER_KM;
      const costTHBperTon = (distKm * COST_THB_PER_KM) / Math.max(1,totalTons);
      const emission = distKm * EMISSION_KG_PER_KM; // kgCO2e

      // decision rules (เหมือนข้อความในรูป)
      const rules = [];
      if(totalFields < 10) rules.push('fields < 10 rai');
      if(totalTons < 5) rules.push('tons < 5');
      if(distKm > 30) rules.push('distance > 30 km');
      if(costTHBperTon > 500) rules.push('cost > 500');
      if(emission > EMISSION_LIMIT) rules.push('emission > Y');

      const go = rules.length===0;

      // สร้าง cell “Decision to go”
      let decisionCellHTML = '';
      if (go) {
        // ปุ่มไปหน้า cluster + เซฟ payload ลง localStorage
        decisionCellHTML =
          `<a class="pill link" href="#" onclick="openCluster('${cid}');return false;">Yes</a>`;
      } else {
        decisionCellHTML =
          '<span class="pill red">No</span><div class="muted">'+rules.join(', ')+'</div>';
      }

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td><b>Cluster ${cid}</b></td>
        <td>${fmt(totalFields)}</td>
        <td>${fmt(totalTons,1)}</td>
        <td>${fmt(distKm,2)}</td>
        <td>${fmt(timeToClusterHr,2)}</td>
        <td>${fmt(timeSpentHr,2)}</td>
        <td>${fmt(energyKWh,2)}</td>
        <td>${fmt(costTHBperTon,2)}</td>
        <td>${fmt(emission,2)}</td>
        <td>${decisionCellHTML}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  // ===== ปุ่มเปิดหน้า cluster: เตรียม payload แล้ว redirect =====
  function openCluster(clusterId){
    const plant = ALL_PLOTS.find(p=>p.is_biochar);
    const members = ALL_PLOTS.filter(p=>!p.is_biochar && p.cluster_id===clusterId);

    if(!members.length){ alert('ไม่พบสมาชิกของคลัสเตอร์นี้'); return; }

    const fc = turf.featureCollection(members.map(p=>turf.point([p.lng,p.lat])));
    const cen = turf.centroid(fc).geometry.coordinates; // [lng,lat]

    const payload = {
      cluster_id: clusterId,
      centroid: {lng: cen[0], lat: cen[1]},
      plant: plant ? {lng:plant.lng, lat:plant.lat, plot_id:plant.plot_id} : null,
      plots: members.map(p=>({plot_id:p.plot_id, lat:p.lat, lng:p.lng, carbon:+p.carbon||0})),
      total_residues: members.reduce((s,p)=>s+(+p.carbon||0),0),
      ts: Date.now()
    };

    localStorage.setItem('selectedCluster', JSON.stringify(payload));
    // ไปหน้า cluster.html (ให้ไฟล์นั้นอ่าน localStorage แล้ววาดเส้นทาง)
    window.location.href = `cluster.html?cluster=${encodeURIComponent(clusterId)}`;
  }
  window.openCluster = openCluster;

  // go!
  bootstrap();
  </script>
</body>
</html>
