<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Enable Earth Demo Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
  <style>
    :root { --primary:#024a18; --secondary:#E8F4E5; --accent:#336633; }
    body { margin: 0; font-family: Arial, sans-serif; background: var(--secondary);}
    header { background: var(--primary); padding: 10px; text-align: center; }
    header img { height: 50px; }
    #controls { background: var(--primary); padding: 10px; text-align: center;}
    #controls button { margin: 0 5px; padding: 8px 12px; background: var(--accent); color: #fff; border: none; border-radius: 4px; cursor: pointer;}
    #controls button:hover { background: #295427;}
    #plot-buttons { display: none; margin-top: 10px; text-align: center;}
    #plot-buttons button { margin: 0 5px; background: #C8E6C9; color: #024a18; border-radius: 4px; border: none; padding: 6px 10px;}
    #plot-buttons button.active { background: #024a18; color: #fff;}
    #add-form-container{ display:none; background:#fff; padding:10px; border-bottom:1px solid #ccc }
    #add-form input{margin:5px;padding:5px;width:110px;border:1px solid #ccc;border-radius:4px}
    #map { height: 58vh;}
    #history { padding: 10px; background: #fff; border-top: 1px solid #ccc;}
    #history h3 { margin-top: 0; color: var(--primary);}
    .cluster-carbon{font-weight:bold;color:#024a18;}
    .cluster-label{display:inline-block;background:#024a18;color:#fff;padding:2px 8px;border-radius:8px;font-size:13px;margin-right:6px;}
    #monitoring video { width: 90%; max-width: 600px; margin: 10px auto; display: block; border-radius: 12px;}
    .go-btn{background:#0041b6;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
    .go-btn:hover{background:#032a78}
  </style>
</head>
<body>
  <header>
    <a href="https://enableearth.eco" target="_blank"><img src="public/logo.jpg" alt="Enable Earth logo"></a>
  </header>
  <div id="controls">
    <button id="btn-showall">Show All</button>
    <button id="btn-history">History Plots</button>
    <button id="btn-addplot">Add Plot</button>
    <button id="btn-routing">Routing</button>
    <button id="btn-monitoring">Monitoring</button>
  </div>
  <div id="plot-buttons"></div>

  <div id="add-form-container">
    <form id="add-form">
      <input id="input-id"  placeholder="Plot ID" required>
      <input id="input-lat" placeholder="Latitude" type="number" step="any" required>
      <input id="input-lng" placeholder="Longitude" type="number" step="any" required>
      <input id="input-carbon" placeholder="Residues(ton)" type="number" step="any" required>
      <button type="button" id="btn-save">Save</button>
      <button type="button" id="btn-cancel">Cancel</button>
    </form>
  </div>

  <div id="map"></div>
  <div id="history"><p>Select a plot to view history.</p></div>

  <div id="monitoring" style="display:none;background:#E8F4E5;padding:16px;text-align:center;">
    <button id="monitoring-close" style="color:#fff;background:#FF0000;border:none;padding:7px 18px;border-radius:5px;font-size:1rem;margin-bottom:6px;cursor:pointer;">Close video</button>
    <video id="video-monitor" controls>
      <source src="video-demo.mp4" type="video/mp4">
      Your browser does not support the video tag.
    </video>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
  <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
  // ========= config =========
  const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/REPLACE_WITH_YOUR_DEPLOYED_WEBAPP_URL/exec"; // <- ใส่ URL ของคุณ (หรือปล่อยว่างเพื่อใช้เฉพาะ localStorage)
  const CLUSTER_PAGE = "cluster.html"; // ไฟล์หน้าคลัสเตอร์
  // =========================

  let map, markerCluster, data, routingCtl;
  let routingActive = false;
  let selectedPoints = [];
  let clusterGroupLayer; // วาดจุด/ป้ายคลัสเตอร์

  function initMap() {
    map = L.map('map').setView([19.2, 99.56], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution:'&copy; OpenStreetMap contributors' }).addTo(map);
    L.Control.geocoder({ defaultMarkGeocode: false }).on('markgeocode', e => map.fitBounds(e.geocode.bbox)).addTo(map);

    fetch('public/call.geojson')
      .then(r => r.json())
      .then(json => {
        data = { type: 'FeatureCollection', features: json.features.map(f => ({ ...f, properties: { hasHistory: true, ...f.properties } })) };
        drawLayer();
        buildPlotButtons();
        setupForm();
        setupControls();
      });
  }

  function drawLayer(filterFn) {
    if(markerCluster) map.removeLayer(markerCluster);
    markerCluster = L.markerClusterGroup();
    const feats = (filterFn ? data.features.filter(filterFn) : data.features)
      .filter(f=>f.properties.plot_id !== "Biochar Plant");

    L.geoJSON(feats, {
      pointToLayer: (f, latlng) => L.marker(latlng),
      onEachFeature: (f, lyr) => {
        lyr.bindPopup(`<strong>${f.properties.plot_id}</strong><br>Residues(ton) ${f.properties.carbon_credit ?? '-'}`);
        lyr.on('click', e => showHistory(f.properties.plot_id));
      }
    }).addTo(markerCluster);

    markerCluster.addTo(map);

    // Biochar marker
    const biochar = data.features.find(f=>f.properties.plot_id==="Biochar Plant");
    if(biochar){
      L.geoJSON(biochar,{
        pointToLayer:(f,latlng)=>L.circleMarker(latlng,{radius:10,color:'#1d3757',weight:2,fillColor:'#5e8af7',fillOpacity:.95}),
        onEachFeature:(f,lyr)=>lyr.bindPopup(`<strong>${f.properties.plot_id}</strong>`)
      }).addTo(map);
    }

    if(feats.length) map.fitBounds(markerCluster.getBounds());
    markerCluster.on('clusterclick', a => map.fitBounds(a.layer.getBounds()));

    // วาด “คลัสเตอร์ที่คำนวณเอง” + ปุ่มไปหน้า cluster
    renderComputedClusters();
  }

  function buildPlotButtons() {
    const div = document.getElementById('plot-buttons');
    div.innerHTML = '';
    data.features.forEach(f => {
      const btn = document.createElement('button');
      btn.textContent = f.properties.plot_id;
      btn.onclick = () => { drawLayer(x => x.properties.plot_id === f.properties.plot_id); showHistory(f.properties.plot_id); };
      div.appendChild(btn);
    });
  }

  function setupControls() {
    document.getElementById('btn-showall').onclick = () => { drawLayer(); document.getElementById('plot-buttons').style.display = "none"; showHistory(); };
    document.getElementById('btn-addplot').onclick = () => toggleForm(true);
    document.getElementById('btn-history').onclick = () => { document.getElementById('plot-buttons').style.display = "block"; };

    document.getElementById('btn-routing').onclick = () => {
      if(routingActive) { closeRoute(); routingActive = false; }
      else { calcBestClusterRoute(); }
    };
    document.getElementById('btn-monitoring').onclick = showMonitoring;
    document.getElementById('monitoring-close').onclick = hideMonitoring;
  }

  function setupForm() {
    document.getElementById('btn-save').onclick = () => {
      const id = document.getElementById('input-id').value.trim();
      const lat = parseFloat(document.getElementById('input-lat').value);
      const lng = parseFloat(document.getElementById('input-lng').value);
      const car = parseFloat(document.getElementById('input-carbon').value);
      if (!id || isNaN(lat) || isNaN(lng) || isNaN(car)) return alert('กรุณากรอกให้ครบ');
      data.features.push({ type: 'Feature', properties: { plot_id: id, carbon_credit: car, hasHistory: true }, geometry: { type: 'Point', coordinates: [lng, lat] } });
      toggleForm(false); drawLayer(); buildPlotButtons(); showHistory(id);
    };
    document.getElementById('btn-cancel').onclick = () => toggleForm(false);
  }
  function toggleForm(sh) { document.getElementById('add-form-container').style.display = sh ? 'block' : 'none'; }

  function showHistory(id) {
    const h = document.getElementById('history');
    if (!id || id === "Biochar Plant") { h.innerHTML = '<p>Select a plot to view history.</p>'; return; }
    const logs = ['2023-01-01 Registered','2023-03-15 No-burn','2025-06-20 Certificate'];
    h.innerHTML = `<h3>History for ${id}</h3><ul>${logs.map(l=>`<li>${l}</li>`).join('')}</ul><button onclick="exportPDF('${id}')">Export PDF</button>`;
  }
  function exportPDF(id) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF(); doc.setFontSize(16); doc.text(`Certificate for ${id}`,20,20);
    ['2023-01-01','2023-03-15','2025-06-20'].forEach((l,i)=>doc.text(l,20,30+10*i));
    doc.save(`certificate_${id}.pdf`);
  }

  function closeRoute() {
    if (routingCtl) { map.removeControl(routingCtl); routingCtl = null; }
    routingActive = false;
    showHistory();
  }

  // ============== ส่วน "คลิกปุ่มไปหน้า Cluster" ==============

  // จัดกลุ่ม (DBSCAN-like) ภายใน 2 กม. (คุณบอกเงื่อนไขล่าสุด)
  function computeClusters(maxKm = 2) {
    const plots = data.features.filter(f => f.properties.plot_id !== "Biochar Plant");
    const used = new Set();
    const clusters = [];
    for (let i = 0; i < plots.length; i++) {
      if (used.has(i)) continue;
      const c = [plots[i]];
      used.add(i);
      for (let j = 0; j < plots.length; j++) {
        if (used.has(j)) continue;
        const d = turf.distance(turf.point(plots[i].geometry.coordinates), turf.point(plots[j].geometry.coordinates), {units:'kilometers'});
        if (d <= maxKm) { c.push(plots[j]); used.add(j); }
      }
      clusters.push(c);
    }
    return clusters;
  }

  function renderComputedClusters() {
    if (clusterGroupLayer) { map.removeLayer(clusterGroupLayer); }
    clusterGroupLayer = L.layerGroup().addTo(map);

    const biochar = data.features.find(f => f.properties.plot_id === "Biochar Plant");
    const clusters = computeClusters(2); // ระยะ 2 กม. เป็นคลัสเตอร์

    clusters.forEach((cluster, idx) => {
      // centroid/สรุป
      const fc = turf.featureCollection(cluster.map(f=>turf.point(f.geometry.coordinates)));
      const centroid = turf.centroid(fc).geometry.coordinates; // [lng,lat]
      const totalResidues = cluster.reduce((s,f)=>s+(+f.properties.carbon_credit||0),0);

      // วง/ป้าย
      const m = L.circleMarker([centroid[1], centroid[0]], {radius:12, color:'#024a18', fillColor:'#79d38e', fillOpacity:0.8})
        .addTo(clusterGroupLayer)
        .bindPopup(`
          <div style="min-width:220px">
            <div class="cluster-label">Cluster #${idx+1}</div>
            <div>Plots: ${cluster.length}</div>
            <div>Total residues: <b>${totalResidues.toFixed(2)}</b> ton</div>
            <div style="margin-top:8px;">
              <button class="go-btn" onclick="goToCluster(${idx})">ไปหน้า Cluster</button>
            </div>
          </div>
        `);

      // เส้นประจาก biochar (เพื่อสื่อว่าเลือกจากโรงงาน)
      if (biochar) {
        const b = [biochar.geometry.coordinates[1], biochar.geometry.coordinates[0]];
        L.polyline([b, [centroid[1], centroid[0]]], {color:'#ff8800', dashArray:'6,6', weight:2, opacity:.7}).addTo(clusterGroupLayer);
      }
    });

    // เก็บคลัสเตอร์ไว้ให้ปุ่มใช้งาน
    window.__computedClusters = clusters;
  }

  // เรียกเมื่อกดปุ่ม “ไปหน้า Cluster”
  async function goToCluster(clusterIndex) {
    const clusters = window.__computedClusters || [];
    const cluster = clusters[clusterIndex];
    if (!cluster) return;

    // เตรียม payload
    const payload = {
      cluster_index: clusterIndex,
      centroid: (() => {
        const fc = turf.featureCollection(cluster.map(f=>turf.point(f.geometry.coordinates)));
        const c = turf.centroid(fc).geometry.coordinates; // [lng,lng]
        return {lng: c[0], lat: c[1]};
      })(),
      plots: cluster.map(f => ({
        plot_id: f.properties.plot_id,
        lat: f.geometry.coordinates[1],
        lng: f.geometry.coordinates[0],
        carbon: +f.properties.carbon_credit || 0
      })),
      total_residues: cluster.reduce((s,f)=>s+(+f.properties.carbon_credit||0),0),
      ts: Date.now()
    };

    // 1) เก็บลง localStorage (ให้ cluster.html อ่านได้ทันที)
    localStorage.setItem('selectedCluster', JSON.stringify(payload));

    // 2) (ออปชัน) ส่งไป Google Sheets ผ่าน Apps Script
    if (SHEETS_WEBAPP_URL && SHEETS_WEBAPP_URL.includes('https://script.google.com')) {
      try {
        await fetch(SHEETS_WEBAPP_URL, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ action: 'saveCluster', data: payload })
        });
      } catch(e) {
        console.warn('ส่งไปชีทไม่สำเร็จ แต่จะพาไปหน้า cluster ต่อได้', e);
      }
    }

    // ไปหน้า cluster พร้อม query string เผื่ออยากใช้ภายหลัง
    const url = `${CLUSTER_PAGE}?cluster=${encodeURIComponent(clusterIndex)}`;
    window.location.href = url;
  }
  window.goToCluster = goToCluster;

  // ============== ของเดิม: หา best cluster โดย net แล้ววาด route (คงไว้) ==============
  async function calcBestClusterRoute() {
    closeRoute();
    routingActive = true;

    const plots = data.features.filter(f => f.properties.plot_id !== "Biochar Plant");
    let clusters = [], visited = new Set();
    const eps = 5; // 5 km
    for (let i = 0; i < plots.length; i++) {
      if (visited.has(i)) continue;
      let cluster = [plots[i]], stack = [i];
      visited.add(i);
      while (stack.length) {
        let idx = stack.pop();
        for (let j = 0; j < plots.length; j++) {
          if (visited.has(j)) continue;
          let dist = turf.distance(
            turf.point(plots[idx].geometry.coordinates),
            turf.point(plots[j].geometry.coordinates),
            { units: 'kilometers' }
          );
          if (dist <= eps) { visited.add(j); stack.push(j); cluster.push(plots[j]); }
        }
      }
      clusters.push(cluster);
    }

    const biochar = data.features.find(f => f.properties.plot_id === "Biochar Plant");
    if (!biochar) return alert('ไม่พบ Biochar Plant');

    let bestResult = null, bestNet = -Infinity;
    for (const cluster of clusters) {
      if(cluster.length<1) continue;
      const waypoints = [biochar, ...cluster, biochar];
      const latlngs = waypoints.map(f=>L.latLng(f.geometry.coordinates[1], f.geometry.coordinates[0]));
      const totalKm = await getRouteDistance(latlngs);
      const carbonSum = cluster.reduce((s,f)=>(s+Number(f.properties.carbon_credit||0)),0);
      const net = (carbonSum * 50) - (totalKm * 5);
      if(net > bestNet) { bestNet = net; bestResult = {carbonSum,totalKm,net,latlngs,plots:cluster}; }
    }
    if(!bestResult) return alert('ไม่พบ cluster ที่คำนวณได้');

    routingCtl = L.Routing.control({
      waypoints: bestResult.latlngs,
      lineOptions: { styles: [{ color: '#0041b6', weight: 5, opacity: .65 }] },
      createMarker: (i,wp)=> L.marker(wp.latLng).bindPopup(i===0||i===bestResult.latlngs.length-1?'Biochar Plant':bestResult.plots[i-1].properties.plot_id),
      addWaypoints: false, routeWhileDragging: false, fitSelectedRoutes: true
    }).addTo(map);

    document.getElementById('history').innerHTML =
      `<h3>Best Cluster Route</h3>
       <ul>
         <li>Number of Plots in Cluster: <span class="cluster-carbon">${bestResult.plots.length}</span></li>
         <li>Total Residues(ton): <span class="cluster-carbon">${bestResult.carbonSum.toFixed(2)}</span></li>
         <li>Distance(km): <span class="cluster-carbon">${bestResult.totalKm.toFixed(2)}</span></li>
         <li>Plots: ${bestResult.plots.map(f=>f.properties.plot_id).join(', ')}</li>
       </ul>`;
    map.fitBounds(L.latLngBounds(bestResult.latlngs));
  }

  async function getRouteDistance(latlngs){
    const coords = latlngs.map(ll=>`${ll.lng},${ll.lat}`).join(';');
    const url = `https://router.project-osrm.org/route/v1/driving/${coords}?overview=false&geometries=geojson`;
    try {
      const res = await fetch(url);
      const json = await res.json();
      if(json.code==='Ok' && json.routes && json.routes.length>0) return json.routes[0].distance/1000;
      else return turf.length(turf.lineString(latlngs.map(ll=>[ll.lng,ll.lat])),{units:'kilometers'});
    } catch(e) {
      return turf.length(turf.lineString(latlngs.map(ll=>[ll.lng,ll.lat])),{units:'kilometers'});
    }
  }

  function showMonitoring() {
    document.getElementById('monitoring').style.display = "block";
    document.getElementById('map').style.display = "none";
    document.getElementById('history').style.display = "none";
    window.scrollTo(0,0);
  }
  function hideMonitoring() {
    document.getElementById('monitoring').style.display = "none";
    document.getElementById('map').style.display = "";
    document.getElementById('history').style.display = "";
  }

  document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
