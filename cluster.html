<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Cluster Focus Route (Parking direct to Subs)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    :root{--left:#b6e89e}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Arial,sans-serif;color:#111}
    header{padding:14px 18px;font-weight:600;color:#e11d48}
    main{max-width:1320px;margin:0 auto;padding:0 16px 30px}
    .layout{display:grid;grid-template-columns:260px 1fr 280px;gap:18px}
    .kbox{background:var(--left);border-radius:26px;padding:20px 14px;text-align:center;margin-bottom:18px}
    .kbox h4{margin:0 0 8px;font-size:18px}
    .kbox .val{font-size:22px;font-weight:700}
    .legend{background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:16px}
    .legend h4{margin:0 0 12px;font-size:18px}
    .lgrow{display:flex;align-items:center;gap:10px;margin:10px 0}
    .dot{width:16px;height:16px;border-radius:50%}
    .dot.red{background:#e11d48}.dot.blue{background:#1d4ed8}.dot.org{background:#f59e0b}
    #map{height:640px;border-radius:10px;overflow:hidden}
    .rtcard{background:var(--left);border-radius:26px;padding:20px 14px;text-align:center;margin:14px 0}
    .rtcard .val{font-size:22px;font-weight:700}
    .searchbar{margin-top:10px;text-align:center}
    .searchbar input{padding:8px 10px;border:1px solid #e5e7eb;border-radius:10px;width:220px}
    @media(max-width:1024px){.layout{grid-template-columns:1fr;gap:12px}#map{height:520px}}
  </style>
</head>
<body>
<header>หน้า Map → สมนึกถึงคลม Cluster <span id="clusterTitle"></span> (Parking → Sub เป็นเส้นตรง)</header>

<main class="layout">
  <!-- LEFT KPIs -->
  <aside>
    <div class="kbox"><h4>Total time (hr)</h4><div class="val" id="kpi_total_time">X</div></div>
    <div class="kbox"><h4>Total wastes available (ton)</h4><div class="val" id="kpi_total_tons">X</div></div>
    <div class="kbox"><h4>Total distance (EV truck) (km)</h4><div class="val" id="kpi_truck_km">X</div></div>
    <div class="kbox"><h4>Total distance (small vehicle) (km)</h4><div class="val" id="kpi_small_km">X</div></div>
    <div class="kbox"><h4>Round trip of small vehicle (no.)</h4><div class="val" id="kpi_rounds">X</div></div>
    <div class="searchbar"><input placeholder="Search"/></div>
  </aside>

  <!-- MAP -->
  <section><div id="map"></div></section>

  <!-- RIGHT: legend & realtime -->
  <aside>
    <div class="legend">
      <div class="lgrow"><span class="dot red"></span><div>Starting point<br/>และ End point</div></div>
      <div class="lgrow"><span class="dot blue"></span><div>Parking point (snap บนถนน)</div></div>
      <div class="lgrow"><span class="dot org"></span><div>Sub‑logistic hub (แต่ละ Plot)</div></div>
    </div>

    <div style="margin-top:14px;font-weight:700">Real‑time of small vehicle</div>
    <div class="rtcard"><div>Payload remained (kg)</div><div class="val" id="rt_payload">X</div></div>
    <div class="rtcard"><div>Speed (km/hr)</div><div class="val" id="rt_speed">X</div></div>
    <div class="rtcard"><div>Battery remained (hr)</div><div class="val" id="rt_batt">X</div></div>
    <div class="rtcard"><div>Elevation (%)</div><div class="val" id="rt_elev">X</div></div>
  </aside>
</main>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
<script>
/* =======================
   CONFIG
   ======================= */
const TRUCK_SPEED_KMH   = 35;   // สำหรับประเมินเวลาเมื่อ OSRM ไม่คืน duration
const WALK_SPEED_KMH    = 4;    // สำหรับคิดเวลาเดิน (แม้จะวาดเส้นตรง)
const LOAD_MIN_PER_STOP = 6;
const SMALL_CAP_TON     = 2;

/* ====== Read payload from localStorage (จาก index.html) ======= */
const payload = JSON.parse(localStorage.getItem('selectedCluster')||'null');

/* ====== Fallback demo ====== */
const demo = {
  cluster_id: 'A',
  centroid: {lat:19.1839, lng:99.5654},
  plant: {lat:19.22956, lng:99.490782, plot_id:'Biochar Plant'},
  plots: [
    {plot_id:'MJD001', lat:19.18492, lng:99.56857, carbon:4.1},
    {plot_id:'MJD002', lat:19.18308, lng:99.56974, carbon:3.9},
    {plot_id:'MJD003', lat:19.18147, lng:99.56686, carbon:4.4},
    {plot_id:'MJD004', lat:19.18441, lng:99.56497, carbon:3.6},
    {plot_id:'MJD005', lat:19.18251, lng:99.56358, carbon:4.2}
  ],
  total_residues: 20.2
};
const data = payload || demo;
const endPoint = data.end || data.plant;

document.getElementById('clusterTitle').textContent = `Cluster ${data.cluster_id}`;

/* ====== Utils ====== */
function km(a,b){
  return turf.distance(turf.point([a.lng,a.lat]), turf.point([b.lng,b.lat]), {units:'kilometers'});
}
function fmt(n,dec=0){ return Number(n).toLocaleString(undefined,{minimumFractionDigits:dec,maximumFractionDigits:dec}); }

/* ===== OSRM helpers (เฉพาะสำหรับเส้นของรถบรรทุก) ===== */
async function osrmNearest(lat,lng){
  const url = `https://router.project-osrm.org/nearest/v1/driving/${lng},${lat}`;
  try{ const r = await fetch(url); const j = await r.json();
    if(j.code==='Ok' && j.waypoints?.length) {
      const [x,y] = j.waypoints[0].location; // lng, lat
      return {lat:y, lng:x};
    }
  }catch(e){}
  return {lat, lng}; // fallback
}
async function osrmRoute(profile, from, to){
  const url = `https://router.project-osrm.org/route/v1/${profile}/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
  try{
    const r = await fetch(url); const j = await r.json();
    if(j.code==='Ok' && j.routes?.length){
      const route = j.routes[0];
      const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);
      const distKm = route.distance/1000;
      const durHr  = (route.duration||0)/3600;
      return {coords, km:distKm, hr:durHr, by:'road'};
    }
  }catch(e){}
  const distKm = km(from,to);
  return {coords:[[from.lat,from.lng],[to.lat,to.lng]], km:distKm, hr: distKm/TRUCK_SPEED_KMH, by:'direct'};
}

/* ====== เลือก Parking: snap บนถนน & ใกล้ Sub มากสุด ====== */
async function pickBestParking(subs, centroid){
  const candidates = [centroid, ...subs.slice(0,8).map(s=>({lat:s.lat,lng:s.lng}))];
  let best = null, bestScore = Infinity;

  for(const c of candidates){
    const snapped = await osrmNearest(c.lat, c.lng);
    const score = subs.reduce((s,p)=>s+km(snapped,{lat:p.lat,lng:p.lng}),0)/subs.length;
    if(score < bestScore){ bestScore = score; best = snapped; }
  }
  return best;
}

/* ====== Map ====== */
const map = L.map('map').setView([data.centroid.lat, data.centroid.lng], 15);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'© OpenStreetMap'}).addTo(map);

const redIcon  = L.divIcon({className:'', html:'<span style="display:inline-block;width:16px;height:16px;background:#e11d48;border:2px solid #fff;border-radius:50%;box-shadow:0 0 0 2px #e11d48"></span>', iconSize:[16,16]});
const blueIcon = L.divIcon({className:'', html:'<span style="display:inline-block;width:16px;height:16px;background:#1d4ed8;border:2px solid #fff;border-radius:50%;box-shadow:0 0 0 2px #1d4ed8"></span>', iconSize:[16,16]});
const orgIcon  = L.divIcon({className:'', html:'<span style="display:inline-block;width:16px;height:16px;background:#f59e0b;border:2px solid #fff;border-radius:50%;box-shadow:0 0 0 2px #f59e0b"></span>', iconSize:[16,16]});

/* ====== วาดทั้งหมด ====== */
(async ()=>{
  // Mark start & end
  const plant = {lat:data.plant.lat, lng:data.plant.lng};
  const centroid = {lat:data.centroid.lat, lng:data.centroid.lng};
  L.marker([plant.lat,plant.lng], {icon:redIcon}).addTo(map).bindPopup(`<b>${data.plant.plot_id}</b><br/>Start`);
  L.marker([endPoint.lat,endPoint.lng], {icon:redIcon}).addTo(map).bindPopup(`<b>${endPoint.plot_id||'End point'}</b><br/>End`);

  // 1) เลือก Parking (บนถนน + ใกล้ Sub มากสุด)
  const subs = data.plots.map(p=>({lat:p.lat,lng:p.lng,id:p.plot_id}));
  const parking = await pickBestParking(subs, centroid);
  L.marker([parking.lat,parking.lng], {icon:blueIcon}).addTo(map).bindPopup(`<b>Parking (on road)</b>`);

  // 2) Plant → Parking (ถนนจริง)
  const r1 = await osrmRoute('driving', plant, parking);
  const line1 = L.polyline(r1.coords, {color:'#1d4ed8',weight:5,opacity:0.95}).addTo(map)
                 .bindPopup(`EV truck: Start → Parking<br/>${fmt(r1.km,2)} กม. (${r1.by})`);

  // 3) Parking → End (ถนนจริง)
  const r2 = await osrmRoute('driving', parking, {lat:endPoint.lat,lng:endPoint.lng});
  const line2 = L.polyline(r2.coords, {color:'#1d4ed8',weight:5,opacity:0.95,dashArray:'8,6'}).addTo(map)
                 .bindPopup(`EV truck: Parking → End<br/>${fmt(r2.km,2)} กม. (${r2.by})`);

  // 4) Parking → Sub (เส้นตรง ไป‑กลับ)
  let walkTotalKm = 0;
  const boundsPts = [...r1.coords, ...r2.coords, [plant.lat,plant.lng], [endPoint.lat,endPoint.lng], [parking.lat,parking.lng]];
  for(const p of data.plots){
    // คำนวณระยะตรง
    const dist = km(parking, {lat:p.lat,lng:p.lng});
    walkTotalKm += dist * 2; // ไป-กลับ
    // วาดเส้นตรง
    L.polyline([[parking.lat,parking.lng],[p.lat,p.lng]], {color:'#f59e0b',weight:4,opacity:0.9}).addTo(map)
      .bindPopup(`Direct: Parking → ${p.plot_id}<br/>ไป‑กลับ ~ ${fmt(dist*2,2)} กม.`);
    L.marker([p.lat,p.lng], {icon:orgIcon}).addTo(map)
      .bindPopup(`<b>${p.plot_id}</b><br/>loading time: ${LOAD_MIN_PER_STOP} min`);
    boundsPts.push([p.lat,p.lng]);
  }

  // KPI รวม
  const truckKm = r1.km + r2.km;
  const truckHr = (r1.hr||r1.km/TRUCK_SPEED_KMH) + (r2.hr||r2.km/TRUCK_SPEED_KMH);
  const walkHr  = walkTotalKm / WALK_SPEED_KMH;    // ใช้ความเร็วเดินเพื่อประเมินเวลา แม้เป็นเส้นตรง
  const loadHr  = (data.plots.length * LOAD_MIN_PER_STOP)/60;
  const totalHr = truckHr + walkHr + loadHr;
  const rounds  = Math.max(1, Math.ceil((data.total_residues||0)/SMALL_CAP_TON));

  document.getElementById('kpi_total_time').textContent = fmt(totalHr,2);
  document.getElementById('kpi_total_tons').textContent  = fmt(data.total_residues||0,1);
  document.getElementById('kpi_truck_km').textContent   = fmt(truckKm,2);
  document.getElementById('kpi_small_km').textContent   = fmt(walkTotalKm,2);
  document.getElementById('kpi_rounds').textContent     = fmt(rounds);

  // Zoom รวม
  map.fitBounds(L.latLngBounds(boundsPts),{padding:[20,20]});
})();

/* ===== Real‑time mock ===== */
function rand(a,b){return (Math.random()*(b-a)+a)}
function tick(){
  document.getElementById('rt_payload').textContent = fmt(rand(200, 1200),0);
  document.getElementById('rt_speed').textContent   = fmt(rand(3, 6),1);
  document.getElementById('rt_batt').textContent    = fmt(rand(2, 6),1);
  document.getElementById('rt_elev').textContent    = fmt(rand(0, 9),1);
}
tick(); setInterval(tick, 2000);
</script>
</body>
</html>
