<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cluster Focus</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <style>
    body{margin:0;font-family:Arial, sans-serif}
    header{padding:10px;background:#024a18;color:#fff}
    #map{height:72vh}
    .pill{display:inline-block;background:#e6f7ea;border:1px solid #bfe4c8;color:#024a18;padding:6px 10px;border-radius:18px;margin:6px 8px 0 0}
  </style>
</head>
<body>
  <header>
    <b>Cluster detail</b>
    <span id="pill-plots" class="pill"></span>
    <span id="pill-carbon" class="pill"></span>
    <a href="index.html" style="float:right;color:#fff;text-decoration:none;">← Back</a>
  </header>
  <div id="map"></div>
  <div style="padding:10px" id="list"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6.5.0/turf.min.js"></script>
  <script>
    const payload = JSON.parse(localStorage.getItem('selectedCluster')||'null');
    if(!payload){ document.body.innerHTML = '<p style="padding:20px">ไม่พบข้อมูลคลัสเตอร์ กรุณากลับไปเลือกจากหน้าแรก</p>'; throw new Error('no data'); }

    const map = L.map('map').setView([payload.centroid.lat, payload.centroid.lng], 15);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

    // centroid (Hub station)
    const hub = L.marker([payload.centroid.lat, payload.centroid.lng], {
      icon: L.icon({iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[32,32]})
    }).addTo(map).bindPopup('Hub station (centroid)').openPopup();

    // plots
    const group = L.featureGroup().addTo(map);
    payload.plots.forEach(p=>{
      const m = L.marker([p.lat, p.lng]).addTo(group).bindPopup(`${p.plot_id}<br>Residues: ${p.carbon}`);
      // เส้นตรงจาก hub → plot
      L.polyline([[payload.centroid.lat, payload.centroid.lng],[p.lat,p.lng]], {color:'#e06a00', dashArray:'5,7'}).addTo(group);
    });
    map.fitBounds(group.getBounds().pad(0.25));

    // สรุปด้านบน
    document.getElementById('pill-plots').textContent = `Plots: ${payload.plots.length}`;
    document.getElementById('pill-carbon').textContent = `Total residues: ${payload.total_residues.toFixed(2)} ton`;

    // รายการ
    const ul = payload.plots.map(p=>`<li>${p.plot_id} — ${p.carbon} ton</li>`).join('');
    document.getElementById('list').innerHTML = `<h3>Members</h3><ul>${ul}</ul>`;
  </script>
</body>
</html>
